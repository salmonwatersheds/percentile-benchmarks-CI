---
title: "Comparison_PSE"
author: "Bruno S. Carturan"
date: "2025-06-16"
output: 
  html_document:
    toc: true                  # Adds a table of contents to the document
    toc_float: true           # Makes the table of contents float on the side as the reader scrolls.
    toc_collapsed: true        # Starts the table of contents in a collapsed state.
    toc_depth: 3               # Specifies the depth of headers (e.g., ##, ###) to include in the table of contents.
    number_sections: true      # 
    theme: journal  # lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, include = FALSE}
wd <- gsub("/Code","",getwd())
wd_Data <- paste0(wd,"/Data")
wd_Code <- paste0(wd,"/Code")

source(paste0(wd,"/Code/functions.R"))

#' Source the functions in the local GitHub repo of population-indicators/spawner-surveys/code
#' The latter repo MUST be in the same local folder containing this project
wd_popInd <- gsub("percentile-benchmarks-CI","population-indicators",wd)
wd_biostatus <- paste0(wd_popInd,"/biological-status")

source(paste0(wd_biostatus,"/code/functions.R"))
source(paste0(wd_popInd,"/code/functions_general.R"))
source(paste0(wd_popInd,"/code/colours.R"))

# Import estimated spawner abundance
cuspawnerabundance <- read.csv(paste0(wd_Data,"/cuspawnerabundance.csv"), header = T)

# Import Biological status
dataset101_biological_status <- read.csv(paste0(wd_Data,"/dataset101_biological_status_2025-06-03.csv"), 
																				 header = T)

# Import benchmarks
dataset102_benchmarks <- read.csv(paste0(wd_Data,"/dataset102_benchmarks_2025-06-03.csv"),
																	header = T)

conservationunits_decoder <- read.csv(paste0(wd_Data,"/conservationunits_decoder.csv"),
																	header = T)

benchmarks <- c(.25,.75)
nBoot <- 5000
numLags <- 1
```

The following CUs have time series that cause the percentile benchmarks to fall outside the simulated confidence intervals (CI), which are obtained by combining bootstrapping and auto-regression modelling. 

The goal of the script is to understand the cause(s) of those issues and to compare the CI obtained with other approaches: naive bootstrapping and block bootstrapping.

# Issue

```{r, echo=FALSE}
#'* ISSUE *
#' all the cases where the percentile benchmarks are outside their CI

cond <- ((dataset102_benchmarks$percentile_upper > dataset102_benchmarks$percentile_upper_975) |
           (dataset102_benchmarks$percentile_upper < dataset102_benchmarks$percentile_upper_025) |
           (dataset102_benchmarks$percentile_lower > dataset102_benchmarks$percentile_lower_975) |
           (dataset102_benchmarks$percentile_lower < dataset102_benchmarks$percentile_lower_025)) &
  !is.na(dataset102_benchmarks$percentile_upper)

show <- dataset102_benchmarks[cond,c("species_name","cu_name_pse","cuid",
                     "percentile_lower_025","percentile_lower","percentile_lower_975",
                     "percentile_upper_025","percentile_upper","percentile_upper_975")]

show$region <- sapply(show$cuid,function(cuid){
	cond <- conservationunits_decoder$cuid == cuid
	return(conservationunits_decoder$region_abbr[cond])
})

show <- show[,c(ncol(show),2:(ncol(show)-1))] 
rownames(show) <- NULL
show
```

In practice, this is not a problem for the CUs whose biostatus is assessed with the "sr" benchmakrs, or is "data-deficient" or "not-assessed". Here below are the CUs which their biostatus determined by the percentile benchmarks:

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid %in% show$cuid
cond_percent <- dataset101_biological_status$psf_status_type == "percentile" & 
	!is.na(dataset101_biological_status$psf_status_type)
cond_123 <- dataset101_biological_status$psf_status_code %in% 1:3

dataset101_biological_status[cond_cuid & cond_percent & cond_123,
														 c("region","species_name","cu_name_pse","cuid","psf_status_type","psf_status")]
```

But we also show the time series and benchmarks and their CIs to CUs with "no estimates of spawner abundance in the most recent generation" (`psf_status_code` = 8). Here below are the ones concerned that also have their biostatus estimated with the percentile approach:

```{r, echo = F}
cond_8 <- dataset101_biological_status$psf_status_code_all == 8 # it has to be with psf_status_code_all

dataset101_biological_status[cond_cuid & cond_percent & cond_8,
														 c("region","species_name","cu_name_pse","cuid","psf_status_type","psf_status")]
```

We separate the CUs depending if their benchmark(s) fall above or below their simulated CI.

## The benchmark(s) fall above the CI(s)

These are the CUs whose benchmark(s) fall above their CI:

```{r,echo=FALSE}
cond <- show$percentile_lower > show$percentile_lower_975 |
	show$percentile_upper > show$percentile_upper_975

show[cond,]
```

```{r, echo = FALSE}
i <- 1
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_509 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_509, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 2
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_529 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_529, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```


```{r, echo = FALSE}
i <- 5
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_214 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_214, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 6
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_1211 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1211, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 7
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_1213 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1213, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

Cases where there is missing data and big gap between two consecutive subsets of the time series: 

```{r, echo = FALSE}
i <- 3
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_582 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_582, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 4
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_333 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_333, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

## The benchmark(s) fall bellow the CI(s)

```{r,echo=FALSE}
cond <- show$percentile_lower < show$percentile_lower_025 |
	show$percentile_upper < show$percentile_upper_025

show[cond,]
```

```{r, echo = FALSE}
i <- 1
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_516 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_516, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 2
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_326 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_326, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 3
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo = F}
cond_cuid <- dataset101_biological_status$cuid == show$cuid[cond][i]
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootOutput_231 <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput_231, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

## Observations:

It seems that the issue is observed either because of (i) a steady increase of decrease of the time series or (2) missing data that could generate relatively high increments between consecutive sub-series.

Let's look at the simulated time series (10% of them) and CI vs. the real time series and benchmarks for certain of the these CUs:

```{r, echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == 509
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_509,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

It seems that the simulated time series tend to be a bit lower than the real series, although it is not obvious.

```{r, echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == 1213
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_1213,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Same comment as above. Also, notice the strange gap in between 1970 and 1985.

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == 326
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_326,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Here (above), it is the opposite pattern: the real time series increase and so the simulated ones tend to be higher and never go as low. Again, there is a strange gap pattern between 1945 and 1950.

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == 231
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_231,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Here the simulated time series never go as low as the original time series. Again, there is the strange gap pattern between 1935 and 1950.

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == 516
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_516,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Here, the simulated time series go much higher and never go as low as the original time series.

# Potential solutions

## Removing NAs at the extremities

The methods so far does not remove the NAs on each tail of the time series. This could cause the simulated time series to be too long and to consequently more likely to reach extremes.

```{r, echo = F}
cuid <- 509
bootOutput_509_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance,
																		remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 300
x_max <- 1700
bootstrap_cuid_hist_fun(bootOutput = bootOutput_509, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_509_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F,
												x_max = x_max, x_min = x_min)
```

```{r,echo = FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_509_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Fixed!

```{r, echo = F}
cuid <- 529
bootOutput_529_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance,
																		remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 180
bootstrap_cuid_hist_fun(bootOutput = bootOutput_529, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_529_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F,
												x_max = x_max, x_min = x_min)
```

```{r,echo = FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_529_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Not fixed. Seems that the auto-regression approach does not consider single points.

```{r, echo = F}
cuid <- 582
bootOutput_582_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																					 nBoot = nBoot, numLags = numLags, 
																					 benchmarks = benchmarks, 
																					 cuspawnerabundance = cuspawnerabundance,
																					 remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 1800
x_max <- 7200
bootstrap_cuid_hist_fun(bootOutput = bootOutput_582, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_582_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F,
												x_max = x_max, x_min = x_min)
```

```{r,echo = FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_582_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Barely fixed.

```{r, echo = F}
cuid <- 333
bootOutput_333_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																					 nBoot = nBoot, numLags = numLags, 
																					 benchmarks = benchmarks, 
																					 cuspawnerabundance = cuspawnerabundance,
																					 remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 30
x_max <- 180
bootstrap_cuid_hist_fun(bootOutput = bootOutput_333, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_333_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F,
												x_max = x_max, x_min = x_min)
```

```{r,echo = FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_333_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Fixed!

```{r, echo = F}
cuid <- 214
bootOutput_214_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																					 nBoot = nBoot, numLags = numLags, 
																					 benchmarks = benchmarks, 
																					 cuspawnerabundance = cuspawnerabundance,
																					 remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 4500
bootstrap_cuid_hist_fun(bootOutput = bootOutput_214, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_214_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F,
												x_max = x_max, x_min = x_min)
```

```{r,echo = FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_214_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Fixed!

```{r, echo = F}
cuid <- 1211
bootOutput_1211_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																					 nBoot = nBoot, numLags = numLags, 
																					 benchmarks = benchmarks, 
																					 cuspawnerabundance = cuspawnerabundance,
																					 remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("species_qualified","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 3000
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1211, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1211_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F,
												x_max = x_max, x_min = x_min)
```

```{r,echo = FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_1211_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Fixed but confidence intervals overlap a lot.

```{r, echo = F}
cuid <- 1213
bootOutput_1213_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance,
																		remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))
x_min <- 9000
x_max <- 130000
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1213, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1213_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_1213_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Fixed!

```{r, echo = F}
cuid <- 326
bootOutput_326_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance,
																		remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))
x_min <- 0
x_max <- 8000
bootstrap_cuid_hist_fun(bootOutput = bootOutput_326, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_326_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_326_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Problem: the benchmarks are inside their CI but the CI overlap totally.

```{r, echo = F}
cuid <- 231
bootOutput_231_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance,
																		remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))
x_min <- 5000
x_max <- 20000
bootstrap_cuid_hist_fun(bootOutput = bootOutput_231, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_231_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_231_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

NOT FIIXED. Could be due to individual data points which are on the lower side. I do not know how individual data points are handled in the Yule-Walker method used to fit the auto-regression model.

```{r, echo = F}
cuid <- 516
bootOutput_516_cut <- bootstrap_ar_cuid_fun(cuid = cuid, 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance,
																		remove_NAs_tails = T)
```

```{r,echo=FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo = F}
layout(matrix(1:2))
par(mar = c(4.5,4.5,2.5,1))
x_min <- 0
x_max <- 45000
bootstrap_cuid_hist_fun(bootOutput = bootOutput_516, benchmarks = benchmarks, 
												main = "With NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
bootstrap_cuid_hist_fun(bootOutput = bootOutput_516_cut, benchmarks = benchmarks, 
												main = "Without NAs at extremes", legend_show = F, 
												x_max = x_max, x_min = x_min)
```

```{r,echo=FALSE}
bootstrap_cuid_plot_fun(bootOutput = bootOutput_516_cut,
												prop_nb_seriesSim = .05, alpha = .1, col_simul = "grey40")
```

Fixed but barely (?).

### Conclusions

- Removing the NAs at the extremities increases the width of the CIs, which potential make them contain the benchmarks.

- The (upper) CI can be much wider and overlap a lot with the other CI (e.g. 1211, 1213, 326).

- The issue is not fixed when individual points in the original time series have extreme values (notably close to 0, e.g. with 582, 231).

- Among the CUs for which the issue would show up on the PSE:
	
	- Yukon CM Middle Yukon (1213) with "percentile" benchmarks: fixed
	
	- CC CK Docee (509) & Skeena CM Middle Skeena (214), "data-deficient": fixed
	
	- CC CO Smith-Inlet (516), "data-deficient": barely fixed.

## Comparision of other bootstrapping approaches

### Methods

Here we compare the benchmark CIs and simulated time series obtained with (1) auto-regression & bootstrapping, (2) block bootstrapping and (3) naive bootstrapping.

We set the length of the block for the block bootstrapping approach to 1/4 of the total length. In a following section we compare the results obtained using different block lengths.

```{r}
blockLength <- 1/4
```

For all three approaches, NAs at the extremities are removed, but the ones in the original time series are left. Consequently, the simulated time series obtained with the block and naive bootstrapping approach can have NAs. For instance, the figure below shows four simulated time series (in red) compared to the original time series (in grey) for Skeena CO Upper Skeena (231):

```{r, echo = FALSE}
cuid <- 231

bootOutput_bootNaive_231 <- bootstrap_cuid_fun(cuid = cuid, 
																					nBoot = nBoot,
																					benchmarks = benchmarks, 
																					cuspawnerabundance = cuspawnerabundance)

bootOutput_bootBlock_231 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo=FALSE, fig.height = 5, fig.width = 8}
layout(matrix(1:4, nrow = 2, byrow = T))
par(mar = c(4.5,4.5,2.5,1))
for(i in 1:4){
	bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_231,prop_nb_seriesSim = .0001,
												col_simul = "red", alpha = .5, col_orginal = alpha("black",.3),
												main = "Block bootstrap", legend_show = F, 
												show_benchmarks = F, show_CI = F)
}
```

In this particular case where there are a lot of missing values in the original time series, the simulated ones can have even more NAs values. **QUESTION:** how to deal with NAs in this case?

The naive bootstrapping approach also potenially generate time series with lots of NAs in this cases, for instance:

```{r, echo=FALSE, fig.height = 5, fig.width = 8}
layout(matrix(1:4, nrow = 2, byrow = T))
par(mar = c(4.5,4.5,2.5,1))
for(i in 1:4){
	bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootNaive_231,prop_nb_seriesSim = .0001,
												col_simul = "red", alpha = .5, col_orginal = alpha("black",.3),
												main = "Naive bootstrap", legend_show = F, 
												show_benchmarks = F, show_CI = F)
}
```

### Results

```{r, echo = FALSE}
cuid <- 509

bootOutput_bootNaive_509 <- bootstrap_cuid_fun(cuid = cuid, 
																					nBoot = nBoot,
																					benchmarks = benchmarks, 
																					cuspawnerabundance = cuspawnerabundance)

bootOutput_bootBlock_509 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE, fig.height = 6, fig.width = 8}
layout(matrix(1:6, nrow = 3, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 300
x_max <- 1600
	
bootstrap_cuid_hist_fun(bootOutput = bootOutput_509_cut, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F, 
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_509_cut,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Bootstrap & auto-regression", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509, benchmarks = benchmarks, 
												main = "Block bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Block bootstrap", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootNaive_509, benchmarks = benchmarks, 
												main = "Naive bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootNaive_509,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Naive bootstrap", legend_show = F)
```

There is not a large difference in the CI among the different approaches.

```{r, echo = FALSE}
cuid <- 1213

bootOutput_bootNaive_1213 <- bootstrap_cuid_fun(cuid = cuid, 
																					nBoot = nBoot,
																					benchmarks = benchmarks, 
																					cuspawnerabundance = cuspawnerabundance)

bootOutput_bootBlock_1213 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE, fig.height = 6, fig.width = 8}
layout(matrix(1:6, nrow = 3, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 1000
x_max <- 200000
	
bootstrap_cuid_hist_fun(bootOutput = bootOutput_1213_cut, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F, 
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_1213_cut,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Bootstrap & auto-regression", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_1213, benchmarks = benchmarks, 
												main = "Block bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_1213,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Block bootstrap", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootNaive_1213, benchmarks = benchmarks, 
												main = "Naive bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootNaive_1213,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Naive bootstrap", legend_show = F)
```

```{r, echo = FALSE}
cuid <- 326

bootOutput_bootNaive_326 <- bootstrap_cuid_fun(cuid = cuid, 
																					nBoot = nBoot,
																					benchmarks = benchmarks, 
																					cuspawnerabundance = cuspawnerabundance)

bootOutput_bootBlock_326 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE, fig.height = 6, fig.width = 8}
layout(matrix(1:6, nrow = 3, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 7000
	
bootstrap_cuid_hist_fun(bootOutput = bootOutput_326_cut, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F, 
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_326_cut,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Bootstrap & auto-regression", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_326, benchmarks = benchmarks, 
												main = "Block bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_326,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Block bootstrap", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootNaive_326, benchmarks = benchmarks, 
												main = "Naive bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootNaive_326,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Naive bootstrap", legend_show = F)
```

The two alternative bootstrap methods do not generate extreme upper benchmark values. Seems strange that the auto-regression approach generate such high abundances?!

```{r, echo = FALSE}
cuid <- 231

# bootOutput_bootNaive_231 <- bootstrap_cuid_fun(cuid = cuid, 
# 																					nBoot = nBoot,
# 																					benchmarks = benchmarks, 
# 																					cuspawnerabundance = cuspawnerabundance)
# 
# bootOutput_bootBlock_231 <- bootstrap_block_cuid_fun(cuid = cuid, 
# 																								 nBoot = nBoot,
# 																								 benchmarks = benchmarks, 
# 																								 blockLength = blockLength,
# 																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE, fig.height = 6, fig.width = 8}
layout(matrix(1:6, nrow = 3, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 20000
	
bootstrap_cuid_hist_fun(bootOutput = bootOutput_231_cut, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F, 
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_231_cut,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Bootstrap & auto-regression", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_231, benchmarks = benchmarks, 
												main = "Block bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_231,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Block bootstrap", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootNaive_231, benchmarks = benchmarks, 
												main = "Naive bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootNaive_231,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Naive bootstrap", legend_show = F)
```

Issue fixed now: the lower benchmark is within its CI with both alternatuve bootstrap methods. The block one produced larger CI.

```{r, echo = FALSE}
cuid <- 516

bootOutput_bootNaive_516 <- bootstrap_cuid_fun(cuid = cuid, 
																					nBoot = nBoot,
																					benchmarks = benchmarks, 
																					cuspawnerabundance = cuspawnerabundance)

bootOutput_bootBlock_516 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE, fig.height = 6, fig.width = 8}
layout(matrix(1:6, nrow = 3, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 38000
	
bootstrap_cuid_hist_fun(bootOutput = bootOutput_516_cut, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F, 
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_516_cut,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Bootstrap & auto-regression", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_516, benchmarks = benchmarks, 
												main = "Block bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_516,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Block bootstrap", legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootNaive_516, benchmarks = benchmarks, 
												main = "Naive bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootNaive_516,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = "Naive bootstrap", legend_show = F)
```

### Conclusion

- The CIs obtained with the block and naive bootstrapping methods always contain the benchmarks, which is expected because only existing data points are sampled.

- The simulated time series obtained with these two approaches are more similar than with the auto-regression approach.

- The block bootstrapping can generate CIs that overlap a lot (e.g. 326, 231).


# Effect of block size

```{r, echo = FALSE}
cuid <- 509

blockLength <- 1/2
bootOutput_bootBlock_509_05 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
blockLength <- 1/6
bootOutput_bootBlock_509_017 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)

blockLength <- 1/12
bootOutput_bootBlock_509_083 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)

# blockLength <- 3
# bootOutput_bootBlock_509_3 <- bootstrap_block_cuid_fun(cuid = cuid, 
# 																								 nBoot = nBoot,
# 																								 benchmarks = benchmarks, 
# 																								 blockLength = blockLength,
# 																								 cuspawnerabundance = cuspawnerabundance)
# 
# blockLength <- 5
# bootOutput_bootBlock_509_5 <- bootstrap_block_cuid_fun(cuid = cuid, 
# 																								 nBoot = nBoot,
# 																								 benchmarks = benchmarks, 
# 																								 blockLength = blockLength,
# 																								 cuspawnerabundance = cuspawnerabundance)
# 
# blockLength <- 10
# bootOutput_bootBlock_509_10 <- bootstrap_block_cuid_fun(cuid = cuid, 
# 																								 nBoot = nBoot,
# 																								 benchmarks = benchmarks, 
# 																								 blockLength = blockLength,
# 																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```

```{r, echo=FALSE, fig.height = 8, fig.width = 8}
layout(matrix(1:8, nrow = 4, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 300
x_max <- 1800

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509_05, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/2 --> ",bootOutput_bootBlock_509_05$blockLength,")"),
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509_05,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/2 --> ",bootOutput_bootBlock_509_05$blockLength,")"), 
												legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/4 --> ",bootOutput_bootBlock_509$blockLength,")"),
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/4 --> ",bootOutput_bootBlock_509$blockLength,")"), 
												legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509_017, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/6 --> ",bootOutput_bootBlock_509_017$blockLength,")"), 
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509_017,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/6 --> ",bootOutput_bootBlock_509_017$blockLength,")"), 
												legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509_083, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/12 --> ",bootOutput_bootBlock_509_083$blockLength,")"), 
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509_083,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/12 --> ",bootOutput_bootBlock_509_083$blockLength,")"), 
												legend_show = F)

# bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509_3, benchmarks = benchmarks, 
# 												main = "Block bootstrap (3)", legend_show = F,
# 												x_min = x_min, x_max = x_max)
# 
# bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509_3,prop_nb_seriesSim = .05,
# 												col_simul = "grey40", alpha = .1, 
# 												main = "Block bootstrap (3)", legend_show = F)
# 
# bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509_5, benchmarks = benchmarks, 
# 												main = "Block bootstrap (5)", legend_show = F,
# 												x_min = x_min, x_max = x_max)

# bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509_5,prop_nb_seriesSim = .05,
# 												col_simul = "grey40", alpha = .1, 
# 												main = "Block bootstrap (5)", legend_show = F)
# 
# bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_509_10, benchmarks = benchmarks, 
# 												main = "Block bootstrap (10)", legend_show = F,
# 												x_min = x_min, x_max = x_max)
# 
# bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_509_10,prop_nb_seriesSim = .05,
# 												col_simul = "grey40", alpha = .1, 
# 												main = "Block bootstrap (10)", legend_show = F)
```


```{r, echo = FALSE}
cuid <- 231

blockLength <- 1/2
bootOutput_bootBlock_231_05 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)

blockLength <- 1/6
bootOutput_bootBlock_231_017 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)

blockLength <- 1/12
bootOutput_bootBlock_231_083 <- bootstrap_block_cuid_fun(cuid = cuid, 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)
```

```{r, echo = FALSE}
cond_cuid <- dataset101_biological_status$cuid == cuid
dataset101_biological_status[cond_cuid,c("region","species_qualified","cu_name_pse","cuid","psf_status_type","psf_status_code_all","psf_status_code","psf_status")]
```


```{r, echo=FALSE, fig.height = 8, fig.width = 8}
layout(matrix(1:8, nrow = 4, byrow = T))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 0
x_max <- 18000

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_231_05, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/2 --> ",bootOutput_bootBlock_231_05$blockLength,")"),
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_231_05,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/2 --> ",bootOutput_bootBlock_231_05$blockLength,")"), 
												legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_231, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/4 --> ",bootOutput_bootBlock_231$blockLength,")"),
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_231,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/4 --> ",bootOutput_bootBlock_231$blockLength,")"), 
												legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_231_017, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/6 --> ",bootOutput_bootBlock_231_017$blockLength,")"), 
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_231_017,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/6 --> ",bootOutput_bootBlock_231_017$blockLength,")"), 
												legend_show = F)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock_231_083, benchmarks = benchmarks, 
												main = paste0("Block bootstrap (1/12 --> ",bootOutput_bootBlock_231_083$blockLength,")"), 
												legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_plot_fun(bootOutput = bootOutput_bootBlock_231_083,prop_nb_seriesSim = .05,
												col_simul = "grey40", alpha = .1, 
												main = paste0("Block bootstrap (1/12 --> ",bootOutput_bootBlock_231_083$blockLength,")"), 
												legend_show = F)

```

## Conclusions

- The CIs look the same for different block lengths.


