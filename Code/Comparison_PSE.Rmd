---
title: "Comparison_PSE"
author: "Bruno S. Carturan"
date: "2025-06-16"
output: 
  html_document:
    toc: true                  # Adds a table of contents to the document
    toc_float: true           # Makes the table of contents float on the side as the reader scrolls.
    toc_collapsed: true        # Starts the table of contents in a collapsed state.
    toc_depth: 3               # Specifies the depth of headers (e.g., ##, ###) to include in the table of contents.
    number_sections: true      # 
    theme: journal  # lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, include = FALSE}
wd <- gsub("/Code","",getwd())
wd_Data <- paste0(wd,"/Data")
wd_Code <- paste0(wd,"/Code")

source(paste0(wd,"/Code/functions.R"))

#' Source the functions in the local GitHub repo of population-indicators/spawner-surveys/code
#' The latter repo MUST be in the same local folder containing this project
wd_popInd <- gsub("percentile-benchmarks-CI","population-indicators",wd)
wd_biostatus <- paste0(wd_popInd,"/biological-status")

source(paste0(wd_biostatus,"/code/functions.R"))
source(paste0(wd_popInd,"/code/functions_general.R"))
source(paste0(wd_popInd,"/code/colours.R"))

# Import estimated spawner abundance
cuspawnerabundance <- read.csv(paste0(wd_Data,"/cuspawnerabundance.csv"), header = T)

# Import Biological status
dataset101_biological_status <- read.csv(paste0(wd_Data,"/dataset101_biological_status_2025-06-03.csv"), 
																				 header = T)

# Import benchmarks
dataset102_benchmarks <- read.csv(paste0(wd_Data,"/dataset102_benchmarks_2025-06-03.csv"),
																	header = T)

conservationunits_decoder <- read.csv(paste0(wd_Data,"/conservationunits_decoder.csv"),
																	header = T)

benchmarks <- c(.25,.75)
nBoot <- 5000
numLags <- 1
```

The following CUs have time series cause the percentile benchmarks to fall outside the simulated confidence interval (CI), which are obtained by combining bootstrapping and auto-regression modelling. 

The goal of the script is to understand the cause(s) of those issues and to compare the CI obained with other approaches: naive bootstrapping and block bootstrapping.

# Issue

```{r, echo=FALSE}
#'* ISSUE *
#' all the cases where the percentile benchmarks are outside their CI

cond <- ((dataset102_benchmarks$percentile_upper > dataset102_benchmarks$percentile_upper_975) |
           (dataset102_benchmarks$percentile_upper < dataset102_benchmarks$percentile_upper_025) |
           (dataset102_benchmarks$percentile_lower > dataset102_benchmarks$percentile_lower_975) |
           (dataset102_benchmarks$percentile_lower < dataset102_benchmarks$percentile_lower_025)) &
  !is.na(dataset102_benchmarks$percentile_upper)

show <- dataset102_benchmarks[cond,c("species_name","cu_name_pse","cuid",
                     "percentile_lower_025","percentile_lower","percentile_lower_975",
                     "percentile_upper_025","percentile_upper","percentile_upper_975")]

show$region <- sapply(show$cuid,function(cuid){
	cond <- conservationunits_decoder$cuid == cuid
	return(conservationunits_decoder$region_abbr[cond])
})

show <- show[,c(ncol(show),2:(ncol(show)-1))] 
rownames(show) <- NULL
show
```

Among those time series are those with benchmark(s) falling above the CI, which could be due to a steady decline, and those where the benchmark(s) fall below.

## The benchmark(s) fall above the CI(s)

```{r,echo=FALSE}
cond <- show$percentile_lower > show$percentile_lower_975 |
	show$percentile_upper > show$percentile_upper_975

show[cond,]
```

```{r, echo = FALSE}
i <- 1
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 2
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```


```{r, echo = FALSE}
i <- 5
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 6
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 7
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

Cases where there is missing data and big gap between two consecutive subsets of the time series: 

```{r, echo = FALSE}
i <- 3
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 4
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

## The benchmark(s) fall bellow the CI(s)

```{r,echo=FALSE}
cond <- show$percentile_lower < show$percentile_lower_025 |
	show$percentile_upper < show$percentile_upper_025

show[cond,]
```

```{r, echo = FALSE}
i <- 1
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 2
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

```{r, echo = FALSE}
i <- 3
plot_spawnerAbundance_benchmarks_fun(cuid = show[cond,]$cuid[i],
                                     cuspawnerabundance = cuspawnerabundance, 
                                     dataset101_biological_status = dataset101_biological_status, 
                                     dataset102_benchmarks = dataset102_benchmarks, 
                                     conservationunits_decoder = conservationunits_decoder, 
                                     figure_print = F, # figure_print, 
                                     wd_figures = wd_figures)
```

```{r, echo=FALSE}
bootOutput <- bootstrap_ar_cuid_fun(cuid = show[cond,]$cuid[i], 
																		nBoot = nBoot, numLags = numLags, 
																		benchmarks = benchmarks, 
																		cuspawnerabundance = cuspawnerabundance)

layout(matrix(1))
par(mar = c(4.5,4.5,2.5,1))
bootstrap_cuid_hist_fun(bootOutput = bootOutput, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F)
```

## Conclusion:

It seems that the issue is observed either because of (i) a steady increase of decrease of the time series or (2) missing data that could generate relatively high increments between consecutive sub-series

# Comparision of other bootstrapping approaches



```{r, echo=FALSE, fig.height = 6, fig.width = 4}
blockLength <- 1/4

i <- 1

bootOutput_bootar <- bootstrap_ar_cuid_fun(cuid = show$cuid[i], 
																					 nBoot = nBoot, numLags = numLags, 
																					 benchmarks = benchmarks, 
																					 cuspawnerabundance = cuspawnerabundance)

bootOutput_bootNaive <- bootstrap_cuid_fun(cuid = show$cuid[i], 
																					nBoot = nBoot,
																					benchmarks = benchmarks, 
																					cuspawnerabundance = cuspawnerabundance)

bootOutput_bootBlock <- bootstrap_block_cuid_fun(cuid = show$cuid[i], 
																								 nBoot = nBoot,
																								 benchmarks = benchmarks, 
																								 blockLength = blockLength,
																								 cuspawnerabundance = cuspawnerabundance)

layout(matrix(1:3, nrow = 3))
par(mar = c(4.5,4.5,2.5,1))

x_min <- 300
x_max <- 1600
	
bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootar, benchmarks = benchmarks, 
												main = "Bootstrap & auto-regression", legend_show = F, 
												x_min = x_min, x_max = x_max)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootBlock, benchmarks = benchmarks, 
												main = "Block bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)

bootstrap_cuid_hist_fun(bootOutput = bootOutput_bootNaive, benchmarks = benchmarks, 
												main = "Naive bootstrap", legend_show = F,
												x_min = x_min, x_max = x_max)
```


